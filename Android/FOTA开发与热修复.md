# OTA开发与热修复

> 注：`FOTA(Firmware Over the Air)`专门指的是使用`OTA(Over the Air)`技术进行的远程无线固件升级。因此，以下所涉及的`OTA`技术开发流程专门可以用于`FOTA`开发。

## OTA开发流程

所谓`OTA(Over-the-Air Technology)`是指手机终端通过无线网下载远程服务器上的升级包，对系统或应用进行升级的技术。进一步说，就是将升级包（update.zip压缩包）写入到（手机）系统存储区。

+ 整包：包含整个system分区中的数据文件；`相当于`**重装系统**

+ 差分包：仅包含新旧两个版本之间的改动部分。只对其中部分存储段的内容进行重写。

生成方式有：

1、`ota_from_target_files`脚本生成制作完整更新软件包(整包)和增量更新软件包(差分包)

2、DIY制作OTA差分包

### OTA升级原理图如下：

![OTA升级原理图](https://s2.ax1x.com/2020/01/07/lcgNrV.png)

1、获取update.zip文件

2、验证签名文件

3、通过installPackage接口升级

4、系统重新启动进入recovery界面（判断/cache/recovery 是否有cmd文件）

5、try_update_binary执行升级脚本

6、finish_recovery 重启

## 热修复

优点有：无需重新发版，即使修复问题；无感知修复、无需下载新应用，代价小；修复成功率高，将损失降到最低。

缺点：热修复因为大量涉及android底层知识，又因为android本身开源，华为vivo小米几大厂商都可能修改底层相关代码，兼容性困难，所以热修复技术开发维护难度巨大，人力和时间投入不菲。目前主要有腾讯，阿里等几家互联网大厂因自身刚性需求，实现此功能。

### 热修复方案

+ 阿里系：AndFix、Dexposed、阿里百川、Sophix：`原理`：从底层二进制入手（c语言）

#### 底层替换原理

底层替换就是直接通过Native层类实现即时的更新，但是由于是在Native层类原有上更改，所以有很多修改的`限制`，比如`不能`增减方法、字段，只能修改方法内的结果内容，过程如下图。

![底层替换原理图](https://s2.ax1x.com/2020/01/07/lcb1mQ.png)

底层替换方案和反射的原理有些关联，ArtMethod结构体就是反射invoke()方法Native中的调用，`AndFix`采用的是替换ArtMethod结构体中的字段，这样会有兼容问题，因为厂商可能会修改ArtMethod结构体，导致方法替换失败。`Sophix`采用的是替换整个ArtMethod结构体，这样不会存在兼容问题。

+ 腾讯系：微信的Tinker、QQ空间的超级补丁、手机QQ的QFix：`原理`：从java加载机制入手。

#### 类加载机制原理

在for循环中，首先遍历出来的是dex文件，然后再是从dex文件中获取class，所以，我们只要让修复好的class打包成一个dex文件，放于Element数组的第一个元素，这样就能保证获取到的class是最新修复好的class了（当然，有bug的class也是存在的，不过是放在了Element数组的最后一个元素中，所以没有机会被拿到而已）。

简单原理图：

![简单原理图](https://s2.ax1x.com/2020/01/07/lcHIJ0.png)

深层原理图：

![类加载机制原理图](https://s2.ax1x.com/2020/01/07/lcHOeJ.png)

#### 对比

热修复技术有三种，这里通过表格的方式进行对比：

![热修复技术对比](https://s2.ax1x.com/2020/01/07/lcbHht.jpg)

## OTA开发与Android热修复技术的相同与差异分析

### 相同

+ 解决紧急修复场景

+ 用户无感知。冷/热启动，生效所耗时长及资源（性能），patch体积

+ apk无感知。对原有项目侵入性低

### 差异

+ OTA技术针对的是**底层系统更新**，方式：`生成整包`或`差分包`进行`增量升级`。

+ 热修复技术针对的是系统上`应用`的更新。
